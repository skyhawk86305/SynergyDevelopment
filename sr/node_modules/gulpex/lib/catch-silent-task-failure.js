'use strict';

var gutil = require('gulp-util');

function catchSilentTaskFailure(gulp) {
    var taskFailed = false,
        politeExit = false,
        tasks = {};

    gulp.on('stop', function() {
        politeExit = true;
    });

    gulp.on('err', function() {
        politeExit = true;
    });

    gulp.on('task_err', function (info) {
        delete tasks[info.task];
        taskFailed = true;
    });

    gulp.on('task_start', function (info) {
        tasks[info.task] = true;
    });

    gulp.on('task_stop', function (info) {
        delete tasks[info.task];
    });

    process.on('exit', function() {
        if (!politeExit) {
            var exitStatus = 2,
                repr = gutil.colors.magenta(exitStatus);
            Object.keys(tasks).forEach(function(taskName) {
                var taskRepr = '\'' + gutil.colors.cyan(taskName) + '\'';
                gutil.log('Failure to call back in', taskRepr);
            });
            gutil.log('Raising exit code to', repr, 'after silent task failure');
            process.exit(exitStatus);
        }
    });
}

module.exports = catchSilentTaskFailure;
