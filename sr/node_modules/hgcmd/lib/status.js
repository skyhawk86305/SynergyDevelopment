'use strict';

var assert = require('assert');

function status(hgcmd, repoPath, callback) {
    hgcmd(repoPath, 'status', [ '-mardcu' ], function (err, outputs) {
        if (err) {
            callback(err);
        }

        var statusMap = {},
            nextStatus,
            nextHandler;

        function eatStatus(chunk) {
            assert(typeof(chunk) === 'string');
            assert(chunk.length === 2);
            assert(chunk[1] === ' ');
            nextStatus = chunk[0];
            nextHandler = eatFilename;
        }

        function eatFilename(chunk) {
            assert(typeof(chunk) === 'string');
            assert(chunk.length >= 2);
            assert(chunk[chunk.length - 1] === '\n');
            statusMap[chunk.slice(0, chunk.length - 1)] = nextStatus;
            nextHandler = eatStatus;
        }

        function eatLine(chunk) {
            nextHandler(chunk);
        }

        nextHandler = eatStatus;
        outputs.forEach(eatLine);
        callback(null, statusMap);
    });
}

module.exports = status;
